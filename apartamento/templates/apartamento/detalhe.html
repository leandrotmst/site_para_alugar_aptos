{% extends 'base.html' %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-6">
    
    <div class="lg:col-span-2 space-y-6">
        <div class="rounded-2xl overflow-hidden shadow-xl bg-gray-100">
            {% if apartamento.foto_principal %}
                <img src="{{ apartamento.foto_principal.url }}" class="w-full h-[400px] object-cover" id="main-photo">
            {% endif %}
            
            <div class="flex gap-2 p-4 overflow-x-auto">
                {% for foto in apartamento.fotos.all %}
                    <img src="{{ foto.imagem.url }}" class="w-20 h-20 object-cover rounded-lg cursor-pointer hover:opacity-75 transition" onclick="document.getElementById('main-photo').src=this.src">
                {% endfor %}
            </div>
        </div>
        
        <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">{{ apartamento.nome }}</h1>
            <div class="prose max-w-none text-gray-600">
                {{ apartamento.descricao|safe }} 
            </div>
        </div>
    </div>

    <div class="lg:col-span-1">
        <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-100 sticky top-4">
            <h3 class="text-xl font-bold mb-4">Simule sua estadia</h3>
            <div class="space-y-4">
                <label class="block text-sm font-medium text-gray-700">Check-in / Check-out</label>
                  <input type="text" id="checkin" value="{{ request.GET.checkin }}" placeholder="Data de entrada" 
                     class="w-full border-gray-300 rounded-lg p-2 border">

                  <input type="text" id="checkout" value="{{ request.GET.checkout }}" placeholder="Data de saída" 
                     class="w-full border-gray-300 rounded-lg p-2 border">
            </div>

            <div id="calculo-container" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                <p class="text-gray-500">Dias selecionados: <span id="qtd-dias" class="font-bold text-black">0</span></p>
                <p class="text-xl font-bold text-blue-600 mt-2">Preço Total Estimado: <span id="total-estimado">R$ 0,00</span></p>
            </div>

            <a id="link-airbnb" href="{{ apartamento.link_anuncio }}" target="_blank" class="mt-6 block w-full bg-red-500 text-white text-center font-bold py-3 rounded-lg hover:bg-red-600 transition opacity-50 pointer-events-none">
                Ver disponibilidade no Airbnb
            </a>
        </div>
    </div>
</div>

<script>
    // Seleção de elementos
    const checkinInput = document.getElementById('checkin');
    const checkoutInput = document.getElementById('checkout');
    const container = document.getElementById('calculo-container');
    const btn = document.getElementById('link-airbnb');
    const diaria = parseFloat("{{ apartamento.preco_diaria }}".replace(',', '.'));
    const urlBase = "{{ apartamento.link_anuncio }}";

    // Função de Cálculo
    function calcularPreco() {
        const d1 = new Date(checkinInput.value);
        const d2 = new Date(checkoutInput.value);

        if (checkinInput.value && checkoutInput.value && d2 > d1) {
            const diff = Math.abs(d2 - d1);
            const dias = Math.ceil(diff / (1000 * 60 * 60 * 24));
            const total = dias * diaria;

            document.getElementById('qtd-dias').innerText = dias;
            document.getElementById('total-estimado').innerText = total.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            
            container.classList.remove('hidden');
            btn.classList.remove('opacity-50', 'pointer-events-none');
            
            // Atualiza link do Airbnb
            btn.href = `${urlBase}?check_in=${checkinInput.value}&check_out=${checkoutInput.value}`;
        } else {
            container.classList.add('hidden');
            btn.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    // Configuração do Flatpickr
    const flatpickrConfig = {
        locale: "pt",
        dateFormat: "Y-m-d",
        minDate: "today",
        onChange: calcularPreco // Agora chama a função correta
    };

    flatpickr("#checkin", flatpickrConfig);
    flatpickr("#checkout", flatpickrConfig);

    // Ela executa a função de cálculo assim que a página termina de carregar
    window.onload = calcularPreco;
</script>
{% endblock %}
